{% extends 'base.html' %}

{% block content %}
    <h2>Step 4/5: Define Bad Regions</h2>
    <h4 class="py-5">Draw regions on the template image, name them, and upload bad image examples for each region. You should have a region for each key component of the thing being inspected.</h4>

    <div class="row">
        <!-- Sidebar for region names and uploading bad images -->
        <div class="col-md-4">
            <!-- Show list of regions added -->
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h4>Regions</h4>
                <button id="addRegionBtn" class="btn btn-primary" onclick="addNewRegion()">Add Region</button>
            </div>

            <ul id="regionList" class="list-group mb-3">
                {% for region in model.regions %}
                    <li class="list-group-item" data-region-id="{{ region.id }}"
                        onclick="selectRegion({{ region.id }}, {{ region.x1 }}, {{ region.y1 }}, {{ region.x2 }}, {{ region.y2 }}, {{ region.bad_images|default([])|tojson }})">
                        {{ region.name }} ({{ region.x1 }}, {{ region.y1 }} - {{ region.x2 }}, {{ region.y2 }})
                    </li>
                {% endfor %}
            </ul>

            <!-- Instructions to draw a region -->
            <p id="drawInstruction" style="display:none; color:blue;">Draw region on the image.</p>

            <!-- Form to name the region and upload bad images -->
            <form id="regionForm" method="POST" action="{{ url_for('main.upload_region_images') }}"
                  enctype="multipart/form-data" style="display:none;">
                <input type="hidden" name="x1" id="x1">
                <input type="hidden" name="y1" id="y1">
                <input type="hidden" name="x2" id="x2">
                <input type="hidden" name="y2" id="y2">

                <h4>Region Name</h4>
                <div class="mb-3">
                    <input type="text" id="region_name" name="region_name" class="form-control" required>
                </div>

                <h4>Fail Description</h4>
                <div class="mb-3">
                    <textarea id="fail_description" name="fail_description" class="form-control" required placeholder="Describe what FAIL looks like in this region"></textarea>
                </div>

                <h4>Pass Description</h4>
                <div class="mb-3">
                    <textarea id="pass_description" name="pass_description" class="form-control" required placeholder="Describe what PASS looks like in this region"></textarea>
                </div>

                <h4>Upload Bad Images for the Region:</h4>
                {% for i in range(1, 6) %}
                    <div class="mb-3">
                        <label for="bad_image_{{ i }}" class="form-label">Upload Bad Image {{ i }}</label>
                        <input type="file" id="bad_image_{{ i }}" name="bad_image_{{ i }}" class="form-control"
                               accept="image/*" onchange="previewImage(event, {{ i }})">
                        <img id="badImagePreview_{{ i }}" style="max-width: 100px; margin-top: 10px; display:none;">
                    </div>
                {% endfor %}

                <button type="submit" class="btn btn-primary">Save Region</button>
                <button type="button" class="btn btn-danger" id="resetRegion">Cancel</button>
            </form>

            <!-- Button to save all model regions -->
            <form method="POST" action="{{ url_for('main.finish_regions') }}">
                <button id="saveRegionsBtn" class="btn btn-success btn-block mt-3" style="width: 100%;" disabled>Save Model Regions</button>
            </form>
        </div>

        <!-- Canvas for drawing the regions -->
        <div class="col-md-8">
            <img id="templateImage" src="{{ url_for('static', filename='uploads/' ~ model.template_image_filename) }}"
                 alt="Template Image" class="img-fluid mb-3" style="display:none;">
            <canvas id="templateCanvas" class="border"></canvas>
        </div>
    </div>

    <script>
        // Initialize canvas and drawing variables
        const canvas = document.getElementById('templateCanvas');
        const ctx = canvas.getContext('2d');
        let startX, startY, isDrawing = false;
        let regions = {{ model.regions|length }};  // Initialize regions count based on existing regions
        let currentRegion = null;

        const templateImage = document.getElementById('templateImage');
        const regionForm = document.getElementById('regionForm');
        const regionList = document.getElementById('regionList');
        const addRegionBtn = document.getElementById('addRegionBtn');
        const drawInstruction = document.getElementById('drawInstruction');
        const saveRegionsBtn = document.getElementById('saveRegionsBtn');  // Get the Save Model Regions button

        // Initially disable drawing and the save button
        let drawingEnabled = false;
        let selectedRegionId = null;

        // Disable the "Save Model Regions" button initially if no regions exist
        if (regions === 0) {
            saveRegionsBtn.disabled = true;
            saveRegionsBtn.style.display = 'none';  // Hide if no regions exist
        } else {
            saveRegionsBtn.disabled = false;
            saveRegionsBtn.style.display = 'block';  // Show if regions exist
        }

        // Draw the template image on the canvas
        templateImage.onload = function () {
            canvas.width = templateImage.width;
            canvas.height = templateImage.height;
            ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);
            templateImage.style.display = 'none'; // hide the actual image element
            drawRegions(); // Draw existing regions on load
        };

        templateImage.src = templateImage.src; // Trigger the image load

        // Drawing functionality
        canvas.addEventListener('mousedown', (e) => {
            if (!drawingEnabled) return; // Only draw after clicking "Add Region"
            isDrawing = true;
            [startX, startY] = [e.offsetX, e.offsetY];
        });

        canvas.addEventListener('mousemove', (e) => {
            if (!isDrawing) return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height); // Redraw the image
            drawRegions(); // Redraw saved regions
            ctx.strokeRect(startX, startY, e.offsetX - startX, e.offsetY - startY); // Draw the new region being added
        });

        canvas.addEventListener('mouseup', (e) => {
            if (!drawingEnabled) return;
            isDrawing = false;
            document.getElementById('x1').value = startX;
            document.getElementById('y1').value = startY;
            document.getElementById('x2').value = e.offsetX;
            document.getElementById('y2').value = e.offsetY;
            regionForm.style.display = 'block';
            drawInstruction.style.display = 'none'; // Hide "Draw region" message
            drawingEnabled = false;
            addRegionBtn.style.display = 'none'; // Hide the "Add Region" button while adding
            hideSaveRegionsButton(); // Hide the save button while adding a new region
        });

        // Draw all saved regions on the canvas
        function drawRegions() {
            {% for region in model.regions %}
            drawRegion({{ region.x1 }}, {{ region.y1 }}, {{ region.x2 }}, {{ region.y2 }});
            {% endfor %}
        }

        // Draw a single region
        function drawRegion(x1, y1, x2, y2, highlight = false) {
            ctx.strokeStyle = highlight ? 'red' : 'black';
            ctx.strokeRect(x1, y1, x2 - x1, y2 - y1);
        }

        // Add new region
        function addNewRegion() {
            // Reset the form fields
            regionForm.reset();

            // Clear image previews
            for (let i = 1; i <= 5; i++) {
                const imgPreview = document.getElementById(`badImagePreview_${i}`);
                imgPreview.src = '';
                imgPreview.style.display = 'none';
            }

            regionForm.style.display = 'none'; // Hide the form initially
            drawInstruction.style.display = 'block'; // Show "Draw region on the image"
            addRegionBtn.style.display = 'none'; // Hide "Add Region" button
            drawingEnabled = true;

            // Clear selection in the sidebar
            document.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('active'));

            // Deselect any previously selected region
            selectedRegionId = null;

            // Hide the save button while adding a new region
            hideSaveRegionsButton();
        }

        // Deselect region and hide form
        function deselectRegion() {
            document.querySelectorAll('.list-group-item').forEach(item => item.classList.remove('active'));
            regionForm.style.display = 'none'; // Hide the form
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(templateImage, 0, 0, canvas.width, canvas.height);
            drawRegions(); // Redraw all regions
            selectedRegionId = null;
        }

        // Enable the "Save Model Regions" button if at least one region exists
        function updateSaveRegionsButton() {
            if (regions > 0) {
                saveRegionsBtn.disabled = false;
                saveRegionsBtn.style.display = 'block';  // Show the button
            } else {
                hideSaveRegionsButton();
            }
        }

        // Hide the "Save Model Regions" button
        function hideSaveRegionsButton() {
            saveRegionsBtn.disabled = true;
            saveRegionsBtn.style.display = 'none';  // Hide the button
        }

        // Automatically zoom out until the entire canvas is visible
        function autoZoomOutCanvas() {
            const canvas = document.getElementById('templateCanvas');
            const canvasContainer = canvas.parentElement;
            const canvasWidth = canvas.width;
            const canvasHeight = canvas.height;
            const containerWidth = canvasContainer.clientWidth;
            const containerHeight = canvasContainer.clientHeight;

            let scaleFactor = Math.min(containerWidth / canvasWidth, containerHeight / canvasHeight);
            if (scaleFactor < 1) {
                document.body.style.transform = `scale(${scaleFactor})`;
                document.body.style.transformOrigin = 'top left';
            }
        }

        // Call the zoom out function after the canvas is loaded
        window.onload = function () {
            autoZoomOutCanvas();
        };

    </script>

{% endblock %}
